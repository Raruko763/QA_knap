# ⚙️ 制約スケーリング：線形＋下駄付き（ex5）

## 🎯 目的
- **容量が少ないクラスタほど制約を強くする**
- **容量が多いクラスタほど制約を弱くする**
- 数値発散を防ぎつつ、距離項とのバランスを安定化。

---

## 🧩 式の概要

\[
u = 1 - \frac{\text{rest}}{\text{max}}, \quad
\text{scale} = 1 + \beta \cdot u
\]

| パラメータ | 意味 | 推奨範囲 |
|-------------|------|-----------|
| rest | 残容量（rest_capacity） | [0, max_capacity] |
| max | 最大容量（max_capacity） | 定数 |
| β | 強化の強さ（下駄の高さ） | 1〜3 |

- \( u \) は「不足度」を表す (0〜1)
- \( \text{scale} \in [1, 1+\beta] \)
- 残容量が少ないほど制約が強くなる

---

## 💻 実装例（Python）

```python
# 線形 + 下駄付きスケーリング
rest = max(rest_capacity, 0.0)
u = 1.0 - rest / max_capacity        # 0〜1（不足度）
beta = 2.0                           # 下駄の高さ（強化度）

scale = 1.0 + beta * u               # 1〜(1+β)
capacity_weight = max_distance * scale

# 制約項を重みづけ
capacity_constraints *= capacity_weight
```

---

## 🔍 例：挙動

| 残容量 | u | scale (β=2.0) | 効果 |
|---------|---|----------------|------|
| max_capacity | 0.0 | 1.0 | 制約ほぼ無視（余裕あり） |
| 0.5×max | 0.5 | 2.0 | 少し強くなる |
| 0.2×max | 0.8 | 2.6 | 強くなる |
| 0 | 1.0 | 3.0 | 最大強化 |

---

## 🧠 解説

### ✅ メリット
- **発散しない（ゼロ割り回避）**
- **直感的**：「足りない分だけ強く」
- **距離項とのスケールが安定**
- **単一パラメータ β で調整可能**

### ⚠️ 注意
- β が大きすぎると（>3〜4）、距離項を圧倒して探索が硬直する
- ex4 のような逆比式に比べて挙動は滑らかだが、あくまで「制約の強弱」なので、**違反ペナルティ（λ）** とは別に併用すると安定する

---

## 🧩 改良オプション

| 目的 | 方法 |
|------|------|
| 制約をさらに滑らかにしたい | シグモイド関数に置き換える（γ, k, cで制御） |
| 制約をもっと強くしたい | βを2.5〜3.0に上げる |
| 制約が強すぎる | βを0.5〜1.0に下げる |
| 残容量0の時だけ極端に強くしたい | scale = 1 + β*u + δ*(rest==0) のように定数項を足す |

---

## 💬 まとめ

> 「容量が少ないほど制約を強く、多いほど弱く」したい場合は、
> **線形＋下駄付きスケーリング（1 + β(1 - rest/max))** が最も安定で扱いやすい。
