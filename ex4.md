# QA後処理 実験仕様まとめ

## 実験の目的

クラスタ間の都市交換（後処理ステップ）における挙動を検証し、
以下の3点を評価する：

1. **スキップ条件**：容量に余裕のないクラスタでの交換処理をスキップする機構の有効性。
2. **終了条件**：イテレーションを「解が同一」ではなく、「都市が1つも移動しなかったら終了」に変更した際の影響。
3. **制約の強度**：容量制約の重みを「残容量」に応じて動的に変化させる手法の有効性。

---

## 実装上の更新点

### 1. スキップ条件の追加

* 隣接クラスタの残容量が0以下（`restcapacity <= 0`）の場合、QA処理をスキップ。
* `swap_time_log` に `skipped=True` として記録。
* 理由を `skip_reason: "no_remaining_capacity_in_next_cluster"` として明示。

### 2. 終了条件の変更

* 旧条件：「前回と同じ解を得たら終了」
* 新条件：「1イテレーション中に都市が1つも移動しなかったら終了」
* 判定は `moved_total == 0` による。

### 3. 容量制約の強度調整

* 制約項に、容量の余裕度に応じた係数を導入：

  ```python
  maxdist = max(np.amax(self.distances_from_mycluster), np.amax(self.distances_from_nextcluster))
  capacity_constraints *= maxdist * (self.maxcapacity / self.restcapacity_of_nextcluster)
  ```
* 残容量が少ないほど制約を強め、満杯クラスタでは交換が抑制される。

---

## 実験設計

### 目的

* アニーリング時間、制約強度、終了条件が経路改善や計算時間に与える影響を調べる。

### 検証パラメータ

| 項目         | 値の候補                          | 目的               |
| ---------- | ----------------------------- | ---------------- |
| アニーリング時間   | 1000 / 3000 / 5000 / 10000 ms | 精度と計算時間のトレードオフ評価 |
| 制約強度スケーリング | なし / 残容量比 / 容量逆数比             | 交換安定性の評価         |
| 終了条件       | moved=0 / 改善率<eps             | 探索終了基準の妥当性確認     |

---

## 実行手順

1. `Qknapcore.py`（最新版）を利用して実験を実行。
2. 出力フォルダ構造：

   ```
   out/<timestamp>/<instance_name>/
     ├── centroid_init.json
     ├── iteration_1.json
     ├── iteration_1_swap_timings.json
     └── ...
   ```
3. 各イテレーションの距離推移を確認。
4. 交換スキップの発生率と総実行時間を比較分析。

---

## 期待される観察結果

* 容量スキップ導入により、無駄なQA呼び出しが削減される。
* 終了条件変更で探索が安定化し、収束が早まる。
* 容量比スケーリングで、過剰な移動が抑えられ、クラスタ容量制約の実効性が上がる。

---

## 今後の拡張予定

* 各クラスタサイズに応じたアニーリング時間の最適化。
* `QA_processors` でのパラメータ自動チューニング（TTS最小化ベース）。
* スキップの統計（比率、累積時間、影響度）の可視化。
